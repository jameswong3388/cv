name: RenderCV (CV PR Preview)

on:
  # Generate old vs new PDFs for a PR preview comment.
  pull_request:
    # opened: initial PR creation
    # synchronize: new commits pushed to the PR branch
    # reopened: PR reopened after being closed
    types: [opened, synchronize, reopened]
    branches: [main, master]

permissions:
  contents: read
  issues: write
  pull-requests: write

concurrency:
  group: rendercv-pr-preview-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  preview:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR head
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install RenderCV
        run: |
          python -m pip install --upgrade pip
          python -m pip install "rendercv[full]==2.6"

      - name: Render CV PDF for base SHA (old)
        run: |
          set -euo pipefail
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          git fetch --no-tags --prune origin "${BASE_SHA}"
          git worktree add base-worktree "${BASE_SHA}"

          pushd base-worktree
          rm -rf cv/rendercv_output
          rendercv render cv/cv.yaml -nomd -nohtml -nopng
          popd

          mkdir -p out/base/cv
          OLD_PDF="$(ls -1t base-worktree/cv/rendercv_output/*.pdf | head -n 1)"
          test -s "$OLD_PDF"
          cp -f "$OLD_PDF" "out/base/cv/JamesWong_CV.pdf"

      - name: Render CV PDF for PR head SHA (new)
        run: |
          set -euo pipefail
          rm -rf cv/rendercv_output
          rendercv render cv/cv.yaml -nomd -nohtml -nopng

          mkdir -p out/head/cv
          NEW_PDF="$(ls -1t cv/rendercv_output/*.pdf | head -n 1)"
          test -s "$NEW_PDF"
          cp -f "$NEW_PDF" "out/head/cv/JamesWong_CV.pdf"

      - name: Compute PDF fingerprints (old vs new)
        run: |
          python - <<'PY'
          import hashlib
          import json
          from pathlib import Path
          
          def sha256_file(path: Path) -> str:
              h = hashlib.sha256()
              with path.open("rb") as f:
                  for chunk in iter(lambda: f.read(1024 * 1024), b""):
                      h.update(chunk)
              return h.hexdigest()
          
          pairs = {
              "cv/JamesWong_CV.pdf": ("out/base/cv/JamesWong_CV.pdf", "out/head/cv/JamesWong_CV.pdf"),
          }
          
          out = {}
          for logical, (old_path, new_path) in pairs.items():
              old_p = Path(old_path)
              new_p = Path(new_path)
              out[logical] = {
                  "old": {"path": old_path, "sha256": sha256_file(old_p), "bytes": old_p.stat().st_size} if old_p.exists() else None,
                  "new": {"path": new_path, "sha256": sha256_file(new_p), "bytes": new_p.stat().st_size} if new_p.exists() else None,
              }
          
          Path("rendercv_pr_fingerprints.json").write_text(json.dumps(out, indent=2), encoding="utf-8")
          print("Wrote rendercv_pr_fingerprints.json")
          PY

      - name: Upload old CV PDF (base)
        id: upload_old
        uses: actions/upload-artifact@v4
        with:
          name: old-cv-pdf-pr-${{ github.event.pull_request.number }}
          path: |
            out/base/cv/JamesWong_CV.pdf

      - name: Upload new CV PDF (head)
        id: upload_new
        uses: actions/upload-artifact@v4
        with:
          name: new-cv-pdf-pr-${{ github.event.pull_request.number }}
          path: |
            out/head/cv/JamesWong_CV.pdf

      - name: Comment on PR with old vs new CV PDF
        if: always()
        uses: actions/github-script@v7
        env:
          OLD_ARTIFACT_URL: ${{ steps.upload_old.outputs.artifact-url }}
          NEW_ARTIFACT_URL: ${{ steps.upload_new.outputs.artifact-url }}
        with:
          script: |
            const fs = require("fs");
            
            const prNumber = context.payload.pull_request.number;
            const baseRef = context.payload.pull_request.base.ref;
            const baseSha = context.payload.pull_request.base.sha;
            const headSha = context.payload.pull_request.head.sha;
            
            const oldArtifactUrl = process.env.OLD_ARTIFACT_URL || "";
            const newArtifactUrl = process.env.NEW_ARTIFACT_URL || "";
            
            // Keep a single comment updated across pushes.
            const marker = "<!-- rendercv-pr-preview -->";
            
            function readJson(path) {
              try {
                return JSON.parse(fs.readFileSync(path, "utf8"));
              } catch {
                return null;
              }
            }
            
            const fp = readJson("rendercv_pr_fingerprints.json") || {};
            
            const fmtFingerprint = (obj, label) => {
              if (!obj) return "n/a";
              const short = obj.sha256 ? `${obj.sha256.slice(0, 12)}â€¦` : "n/a";
              return `\`${label}\` ${short} / ${obj.bytes ?? "?"} bytes`;
            };
            
            const lines = [];
            lines.push(marker);
            lines.push("### RenderCV: CV PR preview (old vs new PDF)");
            lines.push(`- **Base**: \`${baseRef}\` @ \`${baseSha.slice(0, 7)}\``);
            lines.push(`- **PR head**: \`${headSha.slice(0, 7)}\``);
            lines.push("");
            if (oldArtifactUrl) lines.push(`- **Old CV PDF (base)**: ${oldArtifactUrl}`);
            if (newArtifactUrl) lines.push(`- **New CV PDF (PR)**: ${newArtifactUrl}`);
            
            lines.push("");
            lines.push("**PDF fingerprints (sha256 / bytes):**");
            lines.push("");
            lines.push("| File | Old (base) | New (PR) |");
            lines.push("| --- | --- | --- |");
            const files = ["cv/JamesWong_CV.pdf"];
            for (const f of files) {
              const row = fp[f] || {};
              lines.push(`| \`${f}\` | ${fmtFingerprint(row.old, "old")} | ${fmtFingerprint(row.new, "new")} |`);
            }
            
            const body = lines.join("\n");
            
            // Try to find and update the existing marker comment; otherwise create it.
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              per_page: 100,
            });
            
            const existing = comments.find(
              (c) => typeof c.body === "string" && c.body.includes(marker)
            );
            
            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body,
              });
            }


